<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AGRIPRED - Home</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='homepage.css') }}" />
</head>
<body>

  <!-- Header Section -->
  <header>
    <div class="navbar">
      <div class="logo">
        <a href="{{ url_for('home') }}" class="logo-text">AGRIPRED</a>
      </div>
      <nav>
        <a href="{{ url_for('about') }}">About</a>
        <a href="{{ url_for('features') }}">Features</a>
        <a href="{{ url_for('contact') }}">Contact</a>
      </nav>
    </div>
    <div class="hero">
      <h1>Helping farmers detect<br> disease in Paddy Crops</h1>
      <p>Discover the disease spreading in your field and get recommendations to cure and prevent it.</p>
      <a href="#detection" class="get-started">Get Started</a>
    </div>
  </header>

  <!-- Features Section -->
  <section class="features" id="features">
    <div class="feature-item">
      <div class="icon">&#128269;</div>
      <h3>Disease Detection</h3>
      <p>Advanced AI technology to identify crop diseases accurately.</p>
    </div>
    <div class="feature-item">
      <div class="icon">&#128138;</div>
      <h3>Medication Recommendations</h3>
      <p>Get personalized treatment options for your crops.</p>
    </div>
    <div class="feature-item">
      <div class="icon">&#128172;</div>
      <h3>AI Chat Assistant</h3>
      <p>24/7 support for all your agricultural queries.</p>
    </div>
  </section>

  <!-- Disease Detection Section -->
  <section id="detection" class="disease-detection">
    <h2>Image-Based Disease Detection</h2>
    <div class="detection-buttons">
      <button id="upload-btn" class="upload-btn">Upload Image</button>
      <input type="file" id="upload-input" accept="image/*" style="display:none;" />
    </div>

    <div id="preview-container" style="margin-top: 20px; display: none;">
      <img id="preview-img" style="max-width: 300px; border-radius: 10px;" />
      <br />
      <button id="predict-btn" class="upload-btn" style="margin-top: 10px;">Predict</button>
    </div>

    <p id="prediction-result" style="margin-top: 1em; font-weight: bold;"></p>

    <!-- New Text-Based Prediction Section -->
    <hr style="margin:40px 0; border:1px dashed #cde0c9;" />
    <h2>Text-Based Disease Prediction (No Image)</h2>
    <p style="text-align:center; max-width:600px; margin:auto;">
      Describe visible symptoms like “brown spots on leaves” or “yellowing and stunted growth”.
    </p>

    <div id="text-predict-container" style="margin-top: 20px; max-width:600px; margin-left:auto; margin-right:auto;">
      <textarea id="symptom-text" rows="3" placeholder="Describe your crop symptoms here..." 
        style="width:100%; padding:10px; border-radius:8px; border:1px solid #dbe7db; resize:vertical;"></textarea>
      <div style="display:flex; gap:12px; margin-top:10px; justify-content:center;">
        <button id="text-predict-btn" class="upload-btn">Predict from Text</button>
        <button id="text-chat-btn" class="upload-btn alt-btn">Ask AI about Symptoms</button>
      </div>
      <p id="text-prediction-result" style="margin-top:10px; font-weight:600; color:#234c23;"></p>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <div class="footer-section">
        <h4>AGRIPRED</h4>
        <p>Empowering farmers with AI-driven crop disease detection and prevention solutions.</p>
      </div>
      <div class="footer-section">
        <h4>Features</h4>
        <ul>
          <li>Disease Detection</li>
          <li>Treatment Recommendations</li>
          <li>AI Chat Support</li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>Company</h4>
        <ul>
          <li>About Us</li>
          <li>Contact</li>
          <li>Privacy Policy</li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>Connect</h4>
        <ul>
          <li>support@agripred.com</li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      © 2025 Agripred. All rights reserved.
    </div>
  </footer>

  <!-- Upload & Predict Script -->
  <script>
    let uploadedFile = null;

    document.getElementById("upload-btn").addEventListener("click", () => {
      document.getElementById("upload-input").click();
    });

    document.getElementById("upload-input").addEventListener("change", function () {
      uploadedFile = this.files[0];
      if (!uploadedFile) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        document.getElementById("preview-img").src = e.target.result;
        document.getElementById("preview-container").style.display = "block";
        document.getElementById("prediction-result").innerHTML = "";
      };
      reader.readAsDataURL(uploadedFile);
    });

    document.getElementById("predict-btn").addEventListener("click", async () => {
      if (!uploadedFile) return;
      const resultElem = document.getElementById("prediction-result");
      resultElem.innerHTML = "Predicting...";

      const formData = new FormData();
      formData.append("image", uploadedFile);

      try {
        const response = await fetch("/predict", { method: "POST", body: formData });
        const data = await response.json();
        const rawDisease = data.class;
        const disease = rawDisease.replace(/^Rice_/, 'Rice ').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

        resultElem.innerHTML = `
          <div style="margin-top: 1em;">
            <div><strong>Disease:</strong> <span class="predicted-disease">${disease}</span></div>
            <div style="margin-top: 1em;">Refer to the chatbot for detailed explanation...</div>
          </div>
        `;

        const chatInput = document.getElementById("chat-input");
        chatInput.value = rawDisease;
        document.getElementById("chat-form").dispatchEvent(new Event("submit"));

      } catch (err) {
        resultElem.innerHTML = "<p style='color:red;'>Error: Could not analyze the image.</p>";
        console.error(err);
      }
    });
  </script>

  <!-- Chat Widget -->
  <div class="chat-widget">
    <div class="chat-header">AgriPred AI <span class="chat-status">Online</span></div>
    <div id="chat-messages" class="chat-body">
      <div class="chat-message model-message">
        Hello! I'm your agricultural assistant. You can upload an image or describe symptoms to start.
      </div>
    </div>
    <form id="chat-form" class="chat-form">
      <input type="text" id="chat-input" class="chat-input" placeholder="Type your message..." required />
      <button type="submit" class="send-btn">Send</button>
    </form>
  </div>

  <!-- Chat Script -->
  <script>
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');

    function addMessage(role, text) {
      const div = document.createElement('div');
      div.classList.add('chat-message', `${role}-message`);
      div.innerHTML = text.replace(/\n/g, "<br>");
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function getAIResponse(userMsg) {
      try {
        const res = await fetch(`/chat?message=${encodeURIComponent(userMsg)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (data.reply) {
          addMessage('model', data.reply.replace(/\n/g, "<br>"));
        } else {
          addMessage('model', "No reply received from server.");
        }
      } catch (err) {
        console.error("Chat error:", err);
        addMessage('model', "Error contacting AI server. Please check console logs.");
      }
    }

    chatForm.addEventListener('submit', async e => {
      e.preventDefault();
      const userMsg = chatInput.value.trim();
      if (!userMsg) return;

      addMessage('user', userMsg);
      chatInput.value = '';

      const typingElem = document.createElement('div');
      typingElem.classList.add('chat-message', 'model-message');
      typingElem.innerHTML = '<em>Typing...</em>';
      chatMessages.appendChild(typingElem);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      await getAIResponse(userMsg);

      typingElem.remove();
    });
  </script>

  <!-- Text Prediction Script -->
  <script>
    document.getElementById('text-predict-btn').addEventListener('click', async () => {
      const text = document.getElementById('symptom-text').value.trim();
      const out = document.getElementById('text-prediction-result');
      out.innerHTML = '';
      if (!text) {
        out.innerHTML = "<span style='color:#c62828;'>Please describe the symptoms first.</span>";
        return;
      }
      out.innerHTML = "Predicting from symptoms...";
      try {
        const resp = await fetch('/predict_text', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ text })
        });
        const data = await resp.json();
        if (data.class && data.class !== 'Unknown') {
          const readable = data.class.replace(/^Rice_/, 'Rice ').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
          out.innerHTML = `<strong>Disease:</strong> ${readable} (confidence: ${data.confidence}%)`;
          const chatInput = document.getElementById('chat-input');
          chatInput.value = data.class;
          document.getElementById('chat-form').dispatchEvent(new Event('submit'));
        } else {
          out.innerHTML = "<span style='color:#c62828;'>No clear match. Try more details.</span>";
        }
      } catch {
        out.innerHTML = "<span style='color:#c62828;'>Error contacting server.</span>";
      }
    });

    document.getElementById('text-chat-btn').addEventListener('click', () => {
      const text = document.getElementById('symptom-text').value.trim();
      if (!text) return alert("Please describe the symptoms first!");
      document.getElementById('chat-input').value = text;
      document.getElementById('chat-form').dispatchEvent(new Event('submit'));
    });
  </script>
</body>
</html>
